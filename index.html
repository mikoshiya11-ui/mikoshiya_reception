<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MIKOSHIYA å…¥é€€å®¤ + ç‰©è²©ï¼ˆã¾ã¨ã‚ã¦ç²¾ç®—ï¼‰</title>
  <style>
    :root{--bg:#0b1220;--card:rgba(255,255,255,.06);--bd:rgba(255,255,255,.10);--tx:#e8eefc;--mut:#aab6d3;--ok:#28d17c;--bad:#ff4d6d;}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;background:var(--bg);color:var(--tx);}
    .wrap{max-width:980px;margin:0 auto;padding:22px 16px 36px;}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:22px;padding:18px 18px 16px;box-shadow:0 20px 70px rgba(0,0,0,.35);}
    h1{margin:0 0 10px;font-size:22px;font-weight:900;display:flex;gap:10px;align-items:center}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:14px;align-items:start}
    @media(max-width:860px){.grid{grid-template-columns:1fr}}
    .mut{color:var(--mut);font-weight:800}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button,select,input{border-radius:14px;border:1px solid var(--bd);background:rgba(0,0,0,.20);color:var(--tx);padding:14px 16px;font-weight:900;font-size:16px}
    button{cursor:pointer}
    button.primary{background:rgba(40,209,124,.85);color:#062012;border:none}
    button.warn{background:rgba(207,167,255,.95);color:#220a35;border:none}
    button:disabled{opacity:.35;cursor:not-allowed}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);font-weight:900}
    .dot{width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,.35)}
    .dot.on{background:rgba(40,209,124,.95)}
    .box{background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:14px}
    .big{font-size:34px;font-weight:1000;letter-spacing:1px}
    .status{margin-top:12px;padding:12px 14px;border-radius:14px;background:rgba(0,0,0,.25);min-height:46px;white-space:pre-wrap;font-weight:900}
    .status.bad{background:rgba(255,77,109,.12);box-shadow:inset 0 0 0 1px rgba(255,77,109,.35)}
    .hint{margin-top:8px;color:rgba(255,255,255,.45);font-size:12px;line-height:1.5}

    /* QR modal */
    #qrModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:999999;}
    #qrCard{width:min(92vw,540px);background:#111;border:2px solid #333;border-radius:16px;padding:12px;}
    #qrHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
    #qrClose{padding:10px 12px;border-radius:12px;min-width:auto}
    #qrVideo{width:100%;height:60vh;background:#000;border-radius:12px;}
    #qrMsg{margin-top:8px;color:var(--mut);font-weight:900}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸ¦‰ MIKOSHIYA å…¥é€€å®¤ + ç‰©è²©ï¼ˆã¾ã¨ã‚ã¦ç²¾ç®—ï¼‰</h1>

      <div class="grid">
        <div>
          <div class="row" style="justify-content:space-between">
            <div class="mut">æœ¬æ—¥: <span id="today">-</span></div>
            <div class="pill" title="çŠ¶æ…‹">
              <span class="dot" id="dot"></span>
              <span id="stateText">-</span>
            </div>
          </div>

          <div class="row" style="margin-top:10px;justify-content:space-between">
            <div>
              <div class="mut">ä¼šå“¡ID</div>
              <div class="big" id="idText">-</div>
              <div class="hint">A-00001 å½¢å¼</div>
            </div>
            <div class="box" style="min-width:260px">
              <div class="mut">æ»åœ¨ï¼ˆå‚è€ƒï¼‰</div>
              <div style="margin-top:6px;font-weight:1000">
                <div>åˆ†ï¼š<span id="mins">-</span></div>
                <div>è¦‹è¾¼ã¿ï¼š<span id="stayYen">-</span> å††</div>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <button id="btnScan">QRã‚¹ã‚­ãƒ£ãƒ³</button>
            <button class="primary" id="btnEnter">å…¥å®¤</button>
            <button class="warn" id="btnSettle">é€€å®¤ï¼†ç²¾ç®—ï¼ˆAirPayï¼‰</button>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="box" style="flex:1">
              <div class="mut">æœªç²¾ç®— ç‰©è²©</div>
              <div style="margin-top:6px;font-weight:1000">
                <div>é‡‘é¡ï¼š<span id="merchYen">-</span> å††</div>
                <div>ä»¶æ•°ï¼š<span id="merchCount">-</span></div>
              </div>
            </div>
            <div class="box" style="flex:1">
              <div class="mut">ç²¾ç®— åˆè¨ˆï¼ˆè¡¨ç¤ºï¼‰</div>
              <div style="margin-top:6px;font-weight:1000">
                <div>æ»åœ¨ï¼š<span id="settleStay">-</span> å††</div>
                <div>ç‰©è²©ï¼š<span id="settleMerch">-</span> å††</div>
                <div style="font-size:20px">åˆè¨ˆï¼š<span id="settleTotal">-</span> å††</div>
              </div>
            </div>
          </div>

          <div class="box" style="margin-top:14px">
            <div class="mut">ç‰©è²©è¿½åŠ ï¼ˆä¼šå“¡IDã«ç´ä»˜ã‘ â†’ æœ€å¾Œã«ã¾ã¨ã‚ã¦ç²¾ç®—ï¼‰</div>
            <div class="row" style="margin-top:10px">
              <select id="productSel" style="flex:1;min-width:260px"></select>
              <input id="qty" type="number" min="1" value="1" style="width:120px"/>
              <button id="btnAdd">è¿½åŠ </button>
            </div>
            <div class="hint">â€» å…ˆã«ä¼šå“¡IDã‚’QRã§èª­ã¿å–ã£ã¦ã‹ã‚‰è¿½åŠ ã—ã¦ã­</div>
          </div>

          <div class="status" id="status">å¾…æ©Ÿä¸­</div>
          <div class="hint">
            ä½¿ã„æ–¹ï¼š1) QRã‚¹ã‚­ãƒ£ãƒ³ â†’ 2) å…¥å®¤ or ç‰©è²©è¿½åŠ  â†’ 3) é€€å®¤ï¼†ç²¾ç®—ï¼ˆåˆè¨ˆè¡¨ç¤ºï¼‰â†’ AirPayã«åˆè¨ˆå…¥åŠ›
          </div>
        </div>

        <div class="box">
          <div class="mut">æ–™é‡‘ï¼ˆç¨è¾¼ï¼‰</div>
          <div style="margin-top:8px;font-weight:1000;line-height:1.8">
            <div>ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ³ï¼š<span id="pUnitYen">-</span>å†† / <span id="pUnitMin">-</span>åˆ†</div>
            <div>æ—¥ä¸Šé™ï¼š<span id="pCap">-</span>å††</div>
            <div>æœˆé¡ï¼š<span id="pMonthly">-</span>å††</div>
          </div>
          <div class="hint" style="margin-top:10px">
            â€» ã‚«ãƒ¡ãƒ©ãŒPermissionã§è½ã¡ã‚‹æ™‚ã¯ã€Œhttpsã€é…ä¸‹ã§é–‹ã„ã¦ã‚‹ã‹ç¢ºèªï¼ˆGitHub Pagesãªã‚‰OKï¼‰
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- QR Modal -->
  <div id="qrModal">
    <div id="qrCard">
      <div id="qrHead">
        <b>QRã‚¹ã‚­ãƒ£ãƒ³</b>
        <button id="qrClose">é–‰ã˜ã‚‹</button>
      </div>
      <video id="qrVideo" playsinline muted autoplay></video>
      <div id="qrMsg">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™â€¦</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    /**************
     * è¨­å®šï¼ˆã“ã“ã ã‘ã‚ãªãŸã®ç’°å¢ƒã«åˆã‚ã›ã¦ï¼‰
     **************/
    const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbzRmjE5pwfnK88EICyzJQhRrJcxnSgdmcze0s7J9w6_msIlwVhe7b5C7V38gV88jHaNWQ/exec";
    const TOKEN = "MIKOSHIYA_CHANGE_ME_2026"; // GAS CONFIG.TOKEN ã¨æƒãˆã‚‹

    /**************
     * DOM
     **************/
    const qs = s => document.querySelector(s);
    const el = {
      today: qs("#today"),
      dot: qs("#dot"),
      stateText: qs("#stateText"),
      idText: qs("#idText"),
      mins: qs("#mins"),
      stayYen: qs("#stayYen"),
      merchYen: qs("#merchYen"),
      merchCount: qs("#merchCount"),
      settleStay: qs("#settleStay"),
      settleMerch: qs("#settleMerch"),
      settleTotal: qs("#settleTotal"),
      status: qs("#status"),
      pUnitMin: qs("#pUnitMin"),
      pUnitYen: qs("#pUnitYen"),
      pCap: qs("#pCap"),
      pMonthly: qs("#pMonthly"),
      btnScan: qs("#btnScan"),
      btnEnter: qs("#btnEnter"),
      btnSettle: qs("#btnSettle"),
      productSel: qs("#productSel"),
      qty: qs("#qty"),
      btnAdd: qs("#btnAdd"),
      qrModal: qs("#qrModal"),
      qrClose: qs("#qrClose"),
      qrVideo: qs("#qrVideo"),
      qrMsg: qs("#qrMsg"),
    };

    let memberId = "";

    function setStatus(msg, bad=false){
      el.status.textContent = msg;
      el.status.classList.toggle("bad", !!bad);
    }
    function setId(id){
      memberId = String(id||"").trim().toUpperCase();
      el.idText.textContent = memberId || "-";
    }
    function fmtYen(n){
      const x = Number(n||0);
      return isFinite(x) ? String(Math.floor(x)) : "0";
    }

    /**************
     * JSONP APIï¼ˆCORSå›é¿ï¼‰
     **************/
    function api(fn, params={}){
      return new Promise((resolve, reject)=>{
        const cb = "cb_" + Math.random().toString(36).slice(2);
        const q = new URLSearchParams({
          token: TOKEN,
          fn,
          callback: cb,
          ...params,
        });

        const url = GAS_EXEC_URL + "?" + q.toString();
        const script = document.createElement("script");
        script.src = url;

        const timeout = setTimeout(()=>{
          cleanup();
          reject(new Error("API timeout"));
        }, 15000);

        window[cb] = (data)=>{
          cleanup();
          resolve(data);
        };

        script.onerror = ()=>{
          cleanup();
          reject(new Error("API load error"));
        };

        function cleanup(){
          clearTimeout(timeout);
          try{ delete window[cb]; }catch(e){ window[cb] = undefined; }
          if (script && script.parentNode) script.parentNode.removeChild(script);
        }

        document.body.appendChild(script);
      });
    }

    /**************
     * Load / Refresh
     **************/
    async function loadInitial(){
      const init = await api("getInitial");
      if (init && init.ok){
        el.today.textContent = init.today || "-";
        el.pUnitMin.textContent = init.pricing.dropin_unit_min;
        el.pUnitYen.textContent = init.pricing.dropin_unit_yen;
        el.pCap.textContent = init.pricing.daily_cap_yen;
        el.pMonthly.textContent = init.pricing.monthly_yen;
      }
    }

    async function loadProducts(){
      el.productSel.innerHTML = "";
      const res = await api("getProducts");
      const items = (res && res.items) ? res.items : [];
      if (!items.length){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "ï¼ˆPRODUCTSã«å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰";
        el.productSel.appendChild(opt);
        el.btnAdd.disabled = true;
        return;
      }
      for (const p of items){
        const opt = document.createElement("option");
        opt.value = p.product_id;
        opt.textContent = `${p.name}ï¼ˆ${p.price_yen}å††ï¼‰`;
        el.productSel.appendChild(opt);
      }
      el.btnAdd.disabled = false;
    }

    async function refresh(){
      if (!memberId){
        el.dot.classList.remove("on");
        el.stateText.textContent = "æœªèª­ã¿å–ã‚Š";
        el.mins.textContent = "-";
        el.stayYen.textContent = "-";
        el.merchYen.textContent = "-";
        el.merchCount.textContent = "-";
        el.settleStay.textContent = "-";
        el.settleMerch.textContent = "-";
        el.settleTotal.textContent = "-";
        el.btnEnter.disabled = true;
        el.btnSettle.disabled = true;
        el.btnAdd.disabled = true;
        return;
      }

      const st = await api("getMemberStatus", { member_id: memberId });
      if (!st || !st.ok){
        setStatus(st && st.message ? st.message : "ã‚¨ãƒ©ãƒ¼", true);
        return;
      }

      el.today.textContent = st.today || "-";
      el.dot.classList.toggle("on", !!st.is_inside);
      el.stateText.textContent = st.is_inside ? "å…¥å®¤ä¸­" : "é€€å®¤ä¸­";

      el.mins.textContent = (st.minutes == null ? "-" : st.minutes);
      el.stayYen.textContent = fmtYen(st.stay_yen);

      el.merchYen.textContent = fmtYen(st.pending_merch_yen);
      el.merchCount.textContent = (st.pending_merch_count == null ? "-" : st.pending_merch_count);

      el.settleStay.textContent = fmtYen(st.stay_yen);
      el.settleMerch.textContent = fmtYen(st.pending_merch_yen);
      el.settleTotal.textContent = fmtYen(Number(st.stay_yen||0) + Number(st.pending_merch_yen||0));

      el.btnEnter.disabled = !!st.is_inside;
      el.btnSettle.disabled = !st.is_inside;
      el.btnAdd.disabled = false;
    }

    /**************
     * Camera / QR
     **************/
    let camStream = null;
    let scanning = false;

    function openModal(){ el.qrModal.style.display="flex"; }
    function closeModal(){ el.qrModal.style.display="none"; stopCamera(); scanning=false; }

    function stopCamera(){
      if (camStream){
        camStream.getTracks().forEach(t=>t.stop());
        camStream = null;
      }
      el.qrVideo.srcObject = null;
    }

    async function startCamera(){
      const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
      const constraints = isMobile
        ? { video: { facingMode: { ideal: "environment" } }, audio: false }
        : { video: true, audio: false };

      camStream = await navigator.mediaDevices.getUserMedia(constraints);
      el.qrVideo.srcObject = camStream;
      el.qrVideo.setAttribute("playsinline","true");
      el.qrVideo.muted = true;
      await el.qrVideo.play();
    }

    async function scanLoop(){
      if (!scanning) return;
      try{
        // BarcodeDetector å„ªå…ˆ
        if ("BarcodeDetector" in window){
          const detector = new BarcodeDetector({ formats:["qr_code"] });
          const codes = await detector.detect(el.qrVideo);
          if (codes && codes.length){
            onScan(codes[0].rawValue || "");
            return;
          }
        }
        // jsQR fallback
        const w = el.qrVideo.videoWidth, h = el.qrVideo.videoHeight;
        if (w && h){
          const canvas = document.createElement("canvas");
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(el.qrVideo, 0, 0, w, h);
          const img = ctx.getImageData(0,0,w,h);
          const code = jsQR(img.data, w, h);
          if (code && code.data){
            onScan(code.data);
            return;
          }
        }
      }catch(e){}
      requestAnimationFrame(scanLoop);
    }

    function onScan(raw){
      const id = String(raw||"").trim().toUpperCase();
      if (!id) return;
      setId(id);
      el.qrMsg.textContent = `èª­ã¿å–ã‚Šï¼š${id}`;
      setStatus(`èª­ã¿å–ã‚Šï¼š${id}`);
      setTimeout(async ()=>{
        closeModal();
        await refresh();
      }, 250);
    }

    /**************
     * UI events
     **************/
    el.btnScan.addEventListener("click", async ()=>{
      setStatus("ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­â€¦");
      el.qrMsg.textContent = "ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™â€¦";
      try{
        openModal();
        await startCamera();
        el.qrMsg.textContent = "QRã«å‘ã‘ã¦ãã ã•ã„";
        scanning = true;
        scanLoop();
        setStatus("QRã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„");
      }catch(e){
        setStatus("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—: " + (e && e.message ? e.message : e), true);
        el.qrMsg.textContent = "å¤±æ•—: " + (e && e.message ? e.message : e);
      }
    });
    el.qrClose.addEventListener("click", closeModal);

    el.btnEnter.addEventListener("click", async ()=>{
      if (!memberId) return setStatus("å…ˆã«QRã§ä¼šå“¡IDã‚’èª­ã¿å–ã£ã¦ã­", true);
      setStatus("å…¥å®¤å‡¦ç†ä¸­â€¦");
      try{
        const r = await api("enter", { member_id: memberId, source: "kiosk" });
        setStatus(r && r.message ? r.message : "å®Œäº†", !(r && r.ok));
        await refresh();
      }catch(e){
        setStatus("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + (e && e.message ? e.message : e), true);
      }
    });

    el.btnAdd.addEventListener("click", async ()=>{
      if (!memberId) return setStatus("å…ˆã«QRã§ä¼šå“¡IDã‚’èª­ã¿å–ã£ã¦ã­", true);
      const productId = String(el.productSel.value||"");
      const qty = Number(el.qty.value||1);
      if (!productId) return setStatus("å•†å“ã‚’é¸ã‚“ã§ã­", true);

      setStatus("ç‰©è²©è¿½åŠ ä¸­â€¦");
      try{
        const r = await api("addMerch", { member_id: memberId, product_id: productId, qty: String(qty) });
        setStatus(r && r.message ? r.message : "è¿½åŠ ã—ã¾ã—ãŸ", !(r && r.ok));
        await refresh();
      }catch(e){
        setStatus("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + (e && e.message ? e.message : e), true);
      }
    });

    el.btnSettle.addEventListener("click", async ()=>{
      if (!memberId) return setStatus("å…ˆã«QRã§ä¼šå“¡IDã‚’èª­ã¿å–ã£ã¦ã­", true);
      setStatus("é€€å®¤ï¼†ç²¾ç®—ä¸­â€¦");
      try{
        const r = await api("settleAndExit", { member_id: memberId, method: "AirPay" });
        if (!r || !r.ok){
          setStatus(r && r.message ? r.message : "å¤±æ•—", true);
          return;
        }
        el.settleStay.textContent = fmtYen(r.stay_yen);
        el.settleMerch.textContent = fmtYen(r.merch_yen);
        el.settleTotal.textContent = fmtYen(r.total_yen);

        setStatus(
          `${r.message}\n`+
          `æ»åœ¨: ${r.stay_yen}å†† / ç‰©è²©: ${r.merch_yen}å††\n`+
          `åˆè¨ˆ: ${r.total_yen}å††ï¼ˆAirPayã«å…¥åŠ›ï¼‰`
        );
        await refresh();
      }catch(e){
        setStatus("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + (e && e.message ? e.message : e), true);
      }
    });

    /**************
     * init
     **************/
    (async ()=>{
      try{
        setStatus("åˆæœŸåŒ–ä¸­â€¦");
        await loadInitial();
        await loadProducts();
        await refresh();
        setStatus("å¾…æ©Ÿä¸­");
      }catch(e){
        setStatus("åˆæœŸåŒ–å¤±æ•—: " + (e && e.message ? e.message : e), true);
      }
    })();
  </script>
</body>
</html>
