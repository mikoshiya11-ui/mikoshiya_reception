/** ===== JSONP API入口 ===== */
const API_TOKEN = "MIKOSHIYA_CHANGE_ME_2026"; // 好きな長い文字列に変更

function doGet(e) {
  const p = (e && e.parameter) ? e.parameter : {};
  const cb = p.callback || "cb";
  const fn = p.fn || "";
  const token = p.token || "";

  let res;
  try {
    if (token !== API_TOKEN) throw new Error("Invalid token");

    switch (fn) {
      case "getInitial":
        res = getInitial();
        break;
      case "getProducts":
        res = getProducts();
        break;
      case "getMemberStatus":
        res = getMemberStatus(p.memberId || "");
        break;
      case "enter":
        res = enter(p.memberId || "");
        break;
      case "addMerch":
        res = addMerch(p.memberId || "", p.sku || "", Number(p.qty || 1));
        break;
      case "settleAndExit":
        res = settleAndExit(p.memberId || "", p.source || "AirPay");
        break;
      default:
        res = { ok: false, message: "Unknown fn: " + fn };
    }
  } catch (err) {
    res = { ok: false, message: String(err && err.message ? err.message : err) };
  }

  const out = `${cb}(${JSON.stringify(res)})`;
  return ContentService
    .createTextOutput(out)
    .setMimeType(ContentService.MimeType.JAVASCRIPT);
} 
